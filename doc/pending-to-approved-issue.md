# Googleグループ「保留」→「承認」メッセージがシートに出力されない問題

## 問題の概要

Googleグループで「保留」状態のメッセージを「承認」した後、本来ならスプレッドシートに出力されるべきメッセージが出力されない問題が発生しました。

### 発生状況

- **日時**: 2026年1月21日
- **対象メッセージ**: 3件（保留→承認に変更）
- **結果**: 最初は3件とも出力されなかった
  - その後、`SAFETY_MARGIN_MS` を24時間に拡大したところ、1件（緑枠）が出力された
  - 残り2件（赤枠）は、検索件数の増加とその他の修正により出力された

## 原因分析

### 1. 検索件数の制限

**問題点:**
- `GmailApp.search(query, 0, 11)` が最新11件しか取得しない
- 保留→承認したメッセージが、最新11件の範囲外にあった

**影響:**
- 検索結果に含まれないため、処理対象にならない
- ログにも一切記録されない

### 2. 基準時刻（LAST_PROCESSED_THREAD_TIME）の問題

**問題点:**
- `LAST_PROCESSED_THREAD_TIME` が最新のスレッド更新時刻を基準に進んでいく
- 保留状態のメッセージは「元の送信時刻」で並ぶため、承認時点では既に古いスレッドとして扱われる
- `after:` 検索条件から外れてしまう

**影響:**
- 検索範囲外になり、`GmailApp.search()` の結果に含まれない

### 3. 履歴チェックの `break` 問題

**問題点:**
- 履歴チェックで `MESSAGE_ID_HISTORY` にヒットした場合、`break` でスレッド全体の処理を打ち切っていた
- 以前に「保留」状態で一度見たメッセージIDが履歴に残っていると、承認後もスキップされる

**影響:**
- スレッド内の他のメッセージも処理されない
- シート存在チェックまで到達しない

## 解決策

### 1. 検索件数の増加

**修正内容:**
```javascript
// 修正前
const threads = GmailApp.search(query, 0, 11);

// 修正後
const threads = GmailApp.search(query, 0, 60);
```

**理由:**
- クォータ制限を考慮しつつ、より多くのスレッドを取得可能にする
- 保留→承認のタイムラグを考慮した件数設定

### 2. 安全マージンの拡大

**修正内容:**
```javascript
// 修正前
const SAFETY_MARGIN_MS = 10 * 60 * 1000; // 10分

// 修正後
const SAFETY_MARGIN_MS = 24 * 60 * 60 * 1000; // 24時間
```

**理由:**
- 保留→承認までの時間差を考慮
- より広い範囲のメールを検索対象にする

### 3. 履歴チェックの `break` → `continue` 変更

**修正内容:**
```javascript
// 修正前
if (messageIdHistorySet.has(msgId)) {
  skippedByHistory++;
  Logger.log(
    `[重複チェック] 履歴ヒットで打ち切り: メッセージID=${msgId}`
  );
  break;  // スレッド全体を打ち切り
}

// 修正後
if (messageIdHistorySet.has(msgId)) {
  skippedByHistory++;
  Logger.log(
    `[重複チェック] 履歴ヒットでスキップ: メッセージID=${msgId}`
  );
  continue;  // このメッセージだけスキップ
}
```

**理由:**
- 1つのメッセージが履歴にヒットしても、スレッド内の他のメッセージは処理を続ける
- シート存在チェックまで到達できるようにする


### 4. 処理順序の最適化（推奨）

**修正内容:**
```javascript
// シート存在チェックを履歴チェックより先に実行
if (existingMsgIdSetBySheet[sheetName]?.has(msgId)) {
  Logger.log(
    `[重複防止] シートに既に存在するためスキップ: msgId=${msgId}`
  );
  continue;
}

// その後に履歴チェック
if (messageIdHistorySet.has(msgId)) {
  skippedByHistory++;
  Logger.log(
    `[重複チェック] 履歴ヒットでスキップ: メッセージID=${msgId}`
  );
  continue;
}
```

**理由:**
- シートへの存在チェック（永続的な事実）を最優先にする
- 履歴チェック（短期キャッシュ）は補助的な役割にする

## 修正手順（バックフィル実行時）

既に発生してしまった問題を解決するための手順：

1. **コード修正**
   - `main.js` の上記修正を適用

2. **スクリプトプロパティのリセット**
   - `MESSAGE_ID_HISTORY` → `[]`（空配列）
   - `LAST_PROCESSED_THREAD_TIME` → `"0"` または対象メールより前の時刻

3. **手動実行**
   - `saveGmailToSheetBySenderWithDomainFilter` を1回だけ手動実行
   - ログで対象スレッドIDが検索結果に含まれているか確認
   - シートに出力されているか確認

## 今後の推奨事項

### 恒久的な修正として残すべき項目

1. **検索件数の増加**（11件 → 60件）
   - クォータを考慮した適切な件数設定

2. **安全マージンの拡大**（10分 → 24時間）
   - 保留→承認のタイムラグを考慮

3. **履歴チェックの `continue` 化**
   - スレッド全体を打ち切らないようにする

### 運用上の注意点

- **定期実行の頻度**: 保留→承認のタイムラグを考慮した実行間隔を設定
- **クォータ管理**: 検索件数を増やした分、Gmail API のクォータ消費が増えるため注意
- **ログ監視**: 定期的にログを確認し、想定外のスキップが発生していないかチェック

## 関連ファイル

- `main.js`: メイン処理ロジック
- `gas-sync.log`: 実行ログ
- `doc/gmail-quota-error.md`: Gmail クォータエラー関連のドキュメント

## 参考情報

### 問題が発生したスレッドID

- `19be013eaed61466`: 1件目（16:01:59 JST）
- `19be01885bc26118`: 2件目（16:00:58 JST）

### 実行ログの確認ポイント

- `[差分取得] 取得したスレッド数`: 期待する件数が取得できているか
- `[重複チェック] 履歴ヒットでスキップ`: 履歴チェックでスキップされているか
- `[重複防止] シートに既に存在するためスキップ`: シートに既に存在するか
- `[処理完了] 保存件数`: 実際にシートに出力された件数

## 更新履歴

- 2026-01-22: 初版作成
