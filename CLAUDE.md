# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

このプロジェクトは、Gmailグループに届いたメールを送信元ドメインごとに分類してGoogleスプレッドシートへ自動転記するGoogle Apps Script (GAS)です。Node.jsやclaspは不要で、GASエディタに`main.js`を貼り付けるだけで動作します。

## アーキテクチャ

### 動作フロー

1. **差分取得**: `LAST_PROCESSED_THREAD_TIME`を基準に、Gmail検索クエリ(`after:`)で新着スレッドのみを取得
2. **重複防止**: `MESSAGE_ID_HISTORY`(短期キャッシュ)と各シートの既存msgIdで重複チェック
3. **ドメイン分類**: `CATEGORY_DOMAIN_MAP`の設定に基づき、転送元ドメインから書き込み先シート名を決定
4. **バッチ書き込み**: シートごとにバッファを用意し、日時降順ソート後に一括書き込み
5. **状態更新**: 処理したメッセージIDと最終スレッド時刻を`PropertiesService`に保存

### 重要な設計原則

**Gmailクォータ制限への対応（一般Googleアカウント前提）:**
- **検索条件の厳格化**: `after:`を必須使用し、時間で絞り込む（10分の安全マージン適用）
- **取得件数の制限**: 最大11スレッドまでに制限
- **重複処理の防止**: `PropertiesService`で「最終処理時刻」と「メッセージID履歴」を永続管理
- **バッチ処理の徹底**: スプレッドシート操作は`getValues`/`setValues`で一括処理

**ステートフル設計:**
- 初回実行時、`LAST_PROCESSED_THREAD_TIME`が未設定なら「現在時刻 - 10分」で初期化
- スレッドを逆順で処理し、履歴ヒット時に打ち切り（重複回避）
- 処理した最大スレッド時刻を次回実行の基準点として保存

### シート構造

- **手動入力列**: 対応確認、備考、対応者
- **GAS自動生成列**: 送信日時、送信者、件名、本文、添付の有無、スレッドID、メッセージID
- GAS列は保護され、実行ユーザーのみが編集可能（`protectAutoGeneratedColumns`）

### 環境変数（PropertiesService）

必須:
- `SPREADSHEET_ID`: 書き込み先スプレッドシートID
- `GROUP_BASE_URL`: Googleグループ検索URLのベース部分
- `CATEGORY_DOMAIN_MAP`: ドメイン→シート名マッピング（JSON文字列）

自動管理:
- `LAST_PROCESSED_THREAD_TIME`: 最後に処理したスレッドの最終更新時刻（ms）
- `MESSAGE_ID_HISTORY`: 処理済みメッセージID履歴（最大5000件）

## コーディング規約（.cursor/rules.mdcより）

### Googleクォータ制限への配慮
- **Gmail API呼び出しの最小化**: `after:`/`newer_than:`による時間絞り込み必須
- **トリガー実行時間**: 1日合計90分以内、1回の実行は3〜5分上限
- **全件走査の禁止**: 最新N件（20〜50スレッド）に限定
- **スプレッドシート操作**: `getValue`/`setValue`のループ使用禁止、`getValues`/`setValues`でバッチ処理

### JavaScript記法
- `const`, `let`を使用（`var`禁止）
- アロー関数を積極使用
- 命名: キャメルケース（変数・関数）、スネークケース大文字（定数）

### コメント・ドキュメント
- すべて日本語で記述
- 「なぜそうしているか（理由・意図）」を必ず記載
- JSDocで`@param`, `@returns`を含める

## 主要関数

### `saveGmailToSheetBySenderWithDomainFilter()`
メインエントリーポイント。トリガー設定でこの関数を指定。

### ヘルパー関数
- `getGasColumnInfo(sheet)`: GAS自動生成列の開始位置と列数を特定
- `ensureGasHeaders(sheet)`: ヘッダー行を保証（初回実行時に設定）
- `protectAutoGeneratedColumns(sheet)`: GAS列を保護し手動編集を防止
- `extractForwardedName/From/Date(body)`: 転送メール本文から元情報を抽出
- `extractBodyPreview(fullBody)`: 本文プレビュー（最大50文字）を生成

## 開発・テスト手順

**手動実行（初回テスト）:**
1. GASエディタで`saveGmailToSheetBySenderWithDomainFilter`を選択
2. 実行ボタンをクリック（初回は権限承認が必要）
3. スプレッドシートでメール情報が追加されているか確認

**トリガー設定（定期実行）:**
1. GASエディタ左側メニューから「トリガー」を開く
2. 実行する関数: `saveGmailToSheetBySenderWithDomainFilter`
3. イベントのソース: 時間主導型、5〜15分ごと

**ログ確認:**
実行ログは`Logger.log()`で出力。GASエディタの「実行ログ」から確認可能。

## 修正時の注意点

- **クォータ制限**: 新機能追加時もGmail API呼び出しを増やさない設計を維持
- **バッチ処理**: スプレッドシート操作は必ずバッファに溜めてから一括書き込み
- **重複防止**: 新しい判定ロジック追加時は、既存の重複チェック（履歴＋シート内ID）を破壊しない
- **ステートフル**: 処理途中で終了しても次回再開可能な構造を維持
- **GAS列の保護**: `protectAutoGeneratedColumns`の対象範囲を変更する場合は、既存シートの保護も更新
