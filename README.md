## 概要

このプロジェクトは、特定の Gmail アカウントに届いたメールを、送信元ドメインごとに分類してスプレッドシートへ自動転記する Google Apps Script (GAS) です。  
**Googleアカウント・Googleグループ・スプレッドシート** があれば、`main.js` を GAS エディタに貼り付けるだけで利用できます（ローカルの Node 環境や clasp は不要です）。


## 前提条件

- Google を利用できる **Googleアカウント**
- 転記対象とする **Googleグループ（または Gmail アドレス）**
- 書き込み先の **Googleスプレッドシート**


## 準備 1: スプレッドシートを作成する

1. Google スプレッドシートを新規作成します。
2. ブラウザの URL からスプレッドシート ID を控えます。  
   例: `https://docs.google.com/spreadsheets/d/XXXXXXXXXXXXXXXXXXXXXXXXXXXX/edit`  
   → `XXXXXXXXXXXXXXXXXXXXXXXXXXXX` が **SPREADSHEET_ID** です。


## 準備 2: Googleグループを作成する

1. `groups.google.com` を開き、**「グループを作成」** から新しい Googleグループを作成します。
2. 受信させたいメールが届くように、グループのメールアドレス（例: `example@googlegroups.com`）を設定します。
3. グループの設定画面で、少なくとも以下を確認・設定します。
   - 外部アドレスからの投稿を許可するかどうか（必要に応じて許可）
   - メールをアーカイブする設定が有効になっていること
   - トピック（スレッド）を閲覧できるユーザー範囲（組織内 / 全員 など）
4. 作成したグループのページをブラウザで開き、URL に含まれるグループの ID/パス（例: `https://groups.google.com/g/<group-id>` の `<group-id>`）をメモしておきます。

このスクリプトでは、グループそのものの ID を単体の変数としては使わず、後述する `GROUP_BASE_URL` に **グループIDを含んだ検索URLのベース部分** を設定することで利用します。


## 準備 3: GAS プロジェクトを作成して main.js を貼り付ける

1. 作成したスプレッドシートを開きます。
2. メニューから **「拡張機能」 → 「Apps Script」** を選択します。
3. 新しいタブで Apps Script エディタが開きます。
4. 既存の `Code.gs` などに書かれているコードを全て削除します。
5. このリポジトリの `gmail-sheets-gas-sync/main.js` の中身を **すべてコピー** します。
6. Apps Script エディタ上のコードエリアに **貼り付けて保存** します。


## 準備 4: スクリプトプロパティを設定する

このスクリプトでは、以下のスクリプトプロパティを利用します。

- `SPREADSHEET_ID`  
  - 同期先スプレッドシートの ID（先ほど控えたもの）
- `GROUP_BASE_URL`  
  - メールの件名などからスレッドを検索するための **Googleグループ検索 URL のベース部分**
  - 例: Googleグループの画面で適当な件名で検索したときの URL から、検索キーワード以降を取り除いたもの  
    （グループIDを含んだ「ここまで毎回同じになる部分」を `GROUP_BASE_URL` に設定します）
- `CATEGORY_DOMAIN_MAP`  
  - 送信元ドメインごとに書き込み先シート名を振り分けるためのマッピング（JSON文字列）  
  - 例:
    ```json
    {
      "顧客A": ["example.com", "example.org"],
      "顧客B": ["another.com"]
    }
    ```

### 設定手順

1. Apps Script エディタ右上の **「歯車マーク（プロジェクト設定）」** を開きます。
2. 「プロパティ」セクションの **「スクリプトのプロパティを表示」** をクリックします。
3. 「スクリプトのプロパティ」タブで「追加」を押し、次のキーと値を設定します。
   - `SPREADSHEET_ID` : スプレッドシート ID
   - `GROUP_BASE_URL` : 検索用のベース URL
   - `CATEGORY_DOMAIN_MAP` : 上記形式の JSON 文字列
4. すべて入力し終えたら「保存」をクリックします。

補足:

- `LAST_PROCESSED_THREAD_TIME`
- `MESSAGE_ID_HISTORY`

これらはスクリプト実行時に自動的に初期化・更新されるため、事前に設定する必要はありません。


## 動作確認（手動実行）

1. Apps Script エディタ上部の関数プルダウンから  
   **`saveGmailToSheetBySenderWithDomainFilter`** を選択します。
2. 「実行」ボタンをクリックします。
3. 初回実行時は、Gmail とスプレッドシートへのアクセス権限を求める認可ダイアログが表示されます。案内に従って権限を許可してください。
4. 実行が完了したら、対象スプレッドシートを開き、指定したシートにメール情報が追加されているか確認します。


## 定期実行（トリガー設定）

1. Apps Script エディタ左側メニューから **「トリガー」** を開きます。
2. 「トリガーを追加」ボタンをクリックします。
3. 以下のように設定します。
   - 実行する関数: `saveGmailToSheetBySenderWithDomainFilter`
   - 実行するデプロイ: `Head`
   - イベントのソース: 時間主導型
   - 時間ベースのトリガーのタイプ: 任意（例: 5分ごと / 10分ごと など）
4. 保存します。


